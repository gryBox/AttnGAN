<html>

	<head>
		<title>Research Tool</title>
		<meta name="description" content="A crossword puzzle generator.">
		<meta name="author" content="Itay Livni &amp; Michael Wehar">

		<meta charset="utf-8">
		<meta name="viewport" content="width=800">

		<link rel="icon" href="icon.png">
		<link rel="shortcut icon" href="icon.png">
		<link rel="image_src" href="icon.png">
		<meta property="og:image" content="icon.png">

		<!-- bootstrap for user control UI -->
		<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
		<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>

		<link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-slider/9.7.2/css/bootstrap-slider.min.css" rel="stylesheet">
	  	<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-slider/9.7.2/bootstrap-slider.min.js"></script>

	  	<!-- Ask Michael how to fix that style sheets wont interfere -->
		<!-- <link href="/static/css/crossword_ui.css" rel="stylesheet"> -->
		<script src="/static/js/crossword_ui.js"></script>
		<script src="/static/js/layout_generator.js"></script>


		<!-- d3 for network graph UI-->
		<script src="https://d3js.org/d3.v4.min.js" type="text/javascript"></script>
		<script src="https://d3js.org/d3-selection-multi.v1.js"></script>

		<!-- Brython python syntax for js -->
		<script type="text/javascript" src="https://cdn.rawgit.com/brython-dev/brython/3.4.0/www/src/brython.js"></script>




		<style>
			.svg_container{
				    height: 600px;
				    width: 100%;
				    background-color: #eeeeee;
			}
			.well{
				background-color: #eeeeee;
				/*border-bottom	: 2px groove black;
				height: 100px;*/
			}
			#input3 .slider-selection {
				background: #BABABA;
			}
			/*d3*/
			.links line {stroke: #999; stroke-opacity: 0.6;};
			.node {cursor: move;};
			/*On node clicked im pathMaker area*/
/*			.node.fixed{
				fill: #f00;
			};*/
		</style>


	</head>
	<body >
		<!-- Fixed navbar -->
	    <nav class="navbar navbar-default navbar-fixed-top">
	      <div class="container">
	        <div class="navbar-header">
	          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
	            <span class="sr-only">Toggle navigation</span>
	            <span class="icon-bar"></span>
	            <span class="icon-bar"></span>
	            <span class="icon-bar"></span>
	          </button>
	          <a class="navbar-brand" href="/index">tapNotion</a>
	        </div>
	        <div id="navbar" class="collapse navbar-collapse">
	          <ul class="nav navbar-nav">
				<li><a href="/index">Home</a></li>
	            <li class="active"><a href="research_tool">Research Tool</a></li>
	            <li><a href="game_demo">Game Generator</a></li>
	          </ul>
	        </div>
	      </div>
	    </nav>


    <br><br><br><br>
   	<!-- Algo user inputs-->
	<div class="row">



		<div class="container">

			<div class="col-md-2">
		    	<label for="term-input">Term:</label>
		    	<input class="form-control" id='term-input' type="text" name="term-input" value="" readonly>
				<select class="form-control" onchange="document.getElementById('term-input').value=this.value;" id="term-drpdwn", value="">
					<option value=""></option>
					{% for term in usr_choice_dict.premade_maps_lst %}
					<option value="{{term}}"{% if loop.first %} SELECTED{% endif %}>{{ term }}</option>
					{% endfor %}
				</select>
			</div>



			<div class="col-md-2">
		    	<label for="topic-input">Topic:</label>
		    	<input class="form-control" id='topic-input' type="text" name="topic-input" value="" readonly>
				<select class="form-control" onchange="document.getElementById('topic-input').value=this.value;" id="topic-drpdwn" value="">
					<option value=""></option>
					{% for topic in usr_choice_dict.topic_lst %}
					<option value="{{topic}}"{% if loop.first %} SELECTED{% endif %}>{{ topic }}</option>
					{% endfor %}
				</select>
			</div>


			<div class="col-md-5">
				<!-- Max Grade input -->
			  	<script> // https://github.com/seiyria/bootstrap-slider
				  var slider = new Slider('#input3', {
						formatter: function(value) {
							return 'Current value: ' + value;
						}
					});
				</script>

				<!-- Slider -->
				<label for="grd-level-sldr">Grade Level:</label>
				<div class="form-group" id="input3">

				    Easiest  <input id="grade-input" name="grade-input" type="text" data-provide="slider"
				      data-slider-min="2"
				      data-slider-max="21"
				      data-slider-step="1"
				      data-slider-value="13"
				      data-slider-tooltip="show"
				    />  Hardest
				</div>
		</div>

		<div class="col-md-2">
			<div>
			<!-- <button name="submit1" class="btn btn-primary" value='Generate Graph' onclick="load_rawLmap()">Generate Graph</button> -->
			<!-- <button id="submit1" name="submit1" class="btn btn-primary" type="button" onclick="buttonClicked();">Generate Graph</button> -->
				<button type="button" id="submit1" name="submit1" class="btn btn-primary" color="#268bd2" onclick="buttonClicked();">Generate Graph</button>
			<!-- </div> -->
			<br><br>

			<!-- <div> -->
				<button name="submit2" type="submit" class="btn btn-primary" color="#268bd2" value='Generate Crossword' >Generate Crossword</button>
			</div>
		</div>

		</div>

	</div> <!-- End for ROW1: User inputs -->


	<!--Raw node link network graph -->
	<div class="row">

		<!-- Raw node link network graph -->
		<div class="container" name="row2" id="row2">
			<br><H2>Vocabulary Map:</H2><br>
			<div class='svg_container' id='raw-network-graph'></div>
			<!-- <script type="text/javascript" src="static/lmap.js"></script> -->
		</div>
	</div>

<!--    <center>-->
<!--    <h4>If you think this is an idea worth building support us by buying something on Amazon</h4>-->
<!--				<center>-->
<!--				<h5>(enable ads for this site in your adblocker (there are only two)) </h5><br>-->
<!--				</center>-->
<!-- 				<h4>If you think this is an idea worth building donate directly :)</h4><br>
<!--				<center>-->
<!--					<button type="button" class="btn btn-primary btn-lg" onclick="">Donate Now</button>-->
<!--				</center>-->
<!--				<center>-->
<!--				<h4>Or buy something on Amazon </h4><br>-->
<!--				<h5>(enable ads on this site in your adblocker (there are only two)) </h5><br>-->
<!-- -->-->


<!--				<center>-->
<!--				<div id="amzn-assoc-ad-a065458d-25a1-4467-a948-4fb3be37b766" style="max-width:800"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&adInstanceId=a065458d-25a1-4467-a948-4fb3be37b766"></script>-->
<!--				</center>-->
<!--	</center>-->

	<!-- User inputs for path to learn -->
	<!-- <div class="row">
		<div class="container" name="row3" id="row3">
			<br><H4>Drag Nodes:</H4><br>
			<div id='path-maker'></div>
		</div>
	</div> -->

	<!-- User selected link network graph -->
	<div class="row">
		<div class="container" name="row3" id="row3">
			<br><H2>Vocabulary Path:</H2><br>
			<div class='svg_container' id='path-graph'></div>
		</div>
	</div>

	<!-- <rect width="100%" height="500px" style="fill:#eeeeee" /> -->

	<!-- Word Story i.e wiki like artcle that adjusts with age-->
	<div class="row">
		<div class="container" name="lmap-article" id="lmap-article">
			<br><H2>Summary of Vocabulary Path:</H2><br>
			<textarea  rows="15" id="summary"></textarea>
		</div>
	</div>

	<div class="row">
		<div class="container" id="games">
			<br><H2>Games:</H2><br>
			<tt id="puzzle-wrapper"></tt>
		</div>
	</div>
	<!-- <div id="event"></div> -->
		<!-- <script type="text/javascript" src="{{ url_for('static', filename='lmap.js') }}"></script> -->
		<script>
			function buttonClicked(){
				var term = trimInput(document.getElementById("term-input").value);
				var topic = trimInput(document.getElementById("topic-input").value);
				var grade = trimInput(document.getElementById("grade-input").value);
				var xhttp = new XMLHttpRequest();
					xhttp.onreadystatechange = function() {
						if (this.readyState == 4 && this.status == 200) {
							grouped_graph = JSON.parse(this.responseText)
							// console.log('Received: ', server_data)
							//document.getElementById("summary").value = server_data.summary;
							// Game
							// var layout = generateLayout(server_data['gms_cntnt'][term].crswrd_data);
							// $('#puzzle-wrapper').crossword(layout.result);
							// var graph =  server_data.drcted_node_link
							var graph =  grouped_graph
							console.log('Received: ', graph)
							//$('#chart2').html('<script type="text/javascript" src="/lmap.js"')
							var url = "/native_graph?" + "term="+term+"&topic="+topic+"&grade="+grade
							// Inputs
							// Begin making the raw grph
							var width,height
							var chartWidth, chartHeight
							var pthWidth, pthHeight
							var margin
							var svg = d3.select("#raw-network-graph").append("svg")
							var chartLayer = svg.append("g").classed("chartLayer", true)
							var pthHeight = 100
							var pathMaker_area = svg.append("rect").classed("pathLayer", true)
							// Graph size
						    width = document.querySelector("#raw-network-graph").clientWidth
						    height = document.querySelector("#raw-network-graph").clientHeight
						    svg.attr("width", width).attr("height", height)
							margin = {top:0, left:0, bottom:0, right:0 }
						    chartWidth = width - (margin.left+margin.right)
						    chartHeight = (height-pthHeight ) - (margin.top+margin.bottom)
						    // Raw network graph
							chartLayer
								.attr("width", chartWidth)
								.attr("height", chartHeight)
								.attr("transform", "translate("+[margin.left, margin.top]+")");
							// Path maker
							pathMaker_area
								.attr("x", 0)
								.attr("y", 0)
								.attr("width", width)
						        .attr("height", chartHeight)
						        .attr("fill", '#eeeeee')
						        .attr("stroke-width", "4px")
						        .attr("stroke", '#ffffff');
							var color = d3.scaleOrdinal(d3.schemeCategory20);
							var simulation = d3.forceSimulation()
							    .force("link", d3.forceLink().id(function(d) { return d.id; }).distance(25))
							    .force('charge', d3.forceManyBody().strength(-5))
							    .force("center", d3.forceCenter(chartWidth / 2, chartHeight / 2))
							    .force('collision', d3.forceCollide().radius(function(d) {
										return d.node_size *1.5
										}))
							// d3.json(url, function(error, graph) {
							// if (error) throw error;
							var link = svg.append("g")
								.attr("class", "links")
								.selectAll("line")
								.data(graph.links)
								.enter().append("line")
								.attr("stroke-width", function(d) { return (d.Score*100); });
							var node = svg.append("g")
								.attr("class", "nodes")
								.selectAll("circle")
								.data(graph.nodes)
								.enter().append("circle")
								.attr("r", function(d) { return  d.node_size*1.5; })
								.attr("fill", function(d) { return color(d.Grade_Level); })
								.on("click", onclick)
								.call(d3.drag()
								    .on("start", dragstarted)
								    .on("drag", dragged)
								    .on("end", dragended));
							  var label = svg.append("g")
							    .attr("class", "labels")
							    .selectAll("text")
							    .data(graph.nodes)
							    .enter().append("text")
							    .attr('text-anchor', 'middle')
								.attr('dominant-baseline', 'central')
								.style('font-family','Arial')
								.style('font-size','10px')
								.text(function (d) {if (d.node_size >= 3) return  d.label; })
								.on("click", onclick)
								.call(d3.drag()
								      .on("start", dragstarted)
								      .on("drag", dragged)
								      .on("end", dragended)
								      );
							simulation
							    .nodes(graph.nodes)
							    .on("tick", ticked);
							simulation.force("link")
							    .links(graph.links);
							function ticked() {
							  link
							      .attr("x1", function(d) { return d.source.x; })
							      .attr("y1", function(d) { return d.source.y; })
							      .attr("x2", function(d) { return d.target.x; })
							      .attr("y2", function(d) { return d.target.y; });
							  node
							      .attr("cx", function(d) { return d.x; })
							      .attr("cy", function(d) { return d.y; });
							  // update label positions
							  label
							      .attr("x", function(d) { return d.x; })
							      .attr("y", function (d) { return d.y; })
							      //.style("font-size", "20px").style("fill", "#4393c3");
							}
							// });
							function add_term_to_path(d){
							}
							function dragstarted(d) {
								// d3.select(this).classed("fixed", d.fixed = true)
							if (!d3.event.active) simulation.alphaTarget(0.3).restart();
							d.fx = d.x;
							d.fy = d.y;
							}
							function onclick(d){
								// curr_node_fill = d3.select(this).attr("fill");
								// d3.select(this)
								// 	.attr("fill", curr_node_fill)
								// 	.style("opacity", '0.5');
							}
							function dragged(d, chartHeight) {
								d.fx = d3.event.x;
								d.fy = d3.event.y;
								console.log(d3.event.y);
								// Get current color of node
								curr_node_fill = d3.select(this).attr("fill");
								console.log(curr_node_fill);
								// Create magnet to place word
								// console.log(chartHeight)
								path_h = 500
								if (d3.event.y > path_h){
									d3.select(this)
										.attr("fill", curr_node_fill)
										.style("opacity", '0.0');
									} else {
										d3.select(this)
											.attr("fill", curr_node_fill)
											.style("opacity", '0.5');
									}
							}
							function dragended(d) {
								curr_node_fill = d3.select(this).attr("fill");
								path_h = 500
								if (d3.event.y > path_h){
									d3.select(this)
										.attr("fill", curr_node_fill)
										.style("opacity", '0.0');
								} else {
									d3.select(this)
										.attr("fill", curr_node_fill)
										.style("opacity", '1.0');
								}
								if (!d3.event.active) simulation.alphaTarget(0);
								// d3.select(this).style("fill",  function(d) { return color(d.node_color); });
								// .attr("fill", function(d) { return color(d.node_color);
							}
						}
					};
					xhttp.open("POST", "/native_graph", true); // TODO: Put in correct URL
					xhttp.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
					xhttp.send("term="+term+"&topic="+topic+"&grade="+grade);
					window.alert("Submitted: " + "term="+term+"&topic="+topic+"&grade="+grade)
				}
			function trimInput(x){
				var temp = x.replace(/[ ]+/g, " ");
				if(temp.substring(0, 1) == " "){
					temp = temp.substring(1);
				}
				if(temp.substring(temp.length-1, temp.length) == " "){
					temp = temp.substring(0, temp.length-1);
				}
				return temp.toLowerCase();
				}
		</script>


        <footer>
			<div class="container" id="legal">
				<p><small>Patent Pending</small></p>
				<p>  </p>
			</div>
		</footer>

    </body>
	<!-- <script type="text/javascript" src="{{ url_for('static', filename='lmap.js') | safe  }}"></script> -->
</html>